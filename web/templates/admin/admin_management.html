{{define "admin/admin_management.html"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜ç®¡ç† - Huoxingç®¡ç†åå°</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar">
            <div class="sidebar-header">ç«æ˜Ÿç®¡ç†åå°</div>
            <div class="sidebar-menu" id="sidebarMenu"></div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-title">ç®¡ç†å‘˜ç®¡ç†</div>
                <div class="header-right">
                    <a href="/" class="btn btn-default" target="_blank">æŸ¥çœ‹ç½‘ç«™</a>
                    <div class="user-info" onclick="logout()">
                        <div class="avatar">A</div>
                        <span>ç®¡ç†å‘˜</span>
                    </div>
                </div>
            </div>

            <div class="content">
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="showAddModal()">â• æ·»åŠ ç®¡ç†å‘˜</button>
                    <input type="text" class="form-input" id="searchInput" placeholder="æœç´¢ç”¨æˆ·åã€æ˜µç§°æˆ–é‚®ç®±" style="width: 300px;">
                    <button class="btn btn-default" onclick="loadData()">ğŸ” æœç´¢</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 80px;">ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>æ˜µç§°</th>
                                <th>é‚®ç®±</th>
                                <th>æ‰‹æœº</th>
                                <th style="width: 100px;">çŠ¶æ€</th>
                                <th style="width: 180px;">æœ€åç™»å½•</th>
                                <th style="width: 200px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
                <div id="editModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title" id="modalTitle">æ·»åŠ ç®¡ç†å‘˜</div>
                            <button class="modal-close" onclick="closeModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <form id="editForm">
                                <input type="hidden" id="adminId">
                                <div class="form-group">
                                    <label class="form-label">ç”¨æˆ·å *</label>
                                    <input type="text" class="form-input" id="username" required>
                                </div>
                                <div class="form-group" id="passwordGroup">
                                    <label class="form-label">å¯†ç  *</label>
                                    <input type="password" class="form-input" id="password">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">æ˜µç§°</label>
                                    <input type="text" class="form-input" id="nickname">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">é‚®ç®±</label>
                                    <input type="email" class="form-input" id="email">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">æ‰‹æœºå·</label>
                                    <input type="tel" class="form-input" id="mobile">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">çŠ¶æ€</label>
                                    <select class="form-select" id="status">
                                        <option value="1">å¯ç”¨</option>
                                        <option value="0">ç¦ç”¨</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" onclick="closeModal()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveAdmin()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script src="/static/js/admin-sidebar.js"></script>
    <script>
        async function loadData() {
            try {
                const keyword = document.getElementById('searchInput').value;
                let url = '/admin/admins?page=1&page_size=100';
                if (keyword) url += '&keyword=' + encodeURIComponent(keyword);
                
                const result = await API.get(url);
                
                if (result.code === 200) {
                    const list = result.data.items || [];
                    const tbody = document.getElementById('tableBody');
                    
                    if (list.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="empty">æš‚æ— æ•°æ®</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = list.map(item => {
                        const loginTime = item.last_login_time ? new Date(item.last_login_time * 1000).toLocaleString('zh-CN') : '-';
                        return `
                            <tr>
                                <td>${item.admin_id}</td>
                                <td>${item.username}</td>
                                <td>${item.nickname || '-'}</td>
                                <td>${item.email || '-'}</td>
                                <td>${item.mobile || '-'}</td>
                                <td><span class="tag tag-${item.status ? 'success' : 'danger'}">${item.status ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                                <td>${loginTime}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editAdmin(${item.admin_id})">ç¼–è¾‘</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteAdmin(${item.admin_id})">åˆ é™¤</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    Utils.showMessage('åŠ è½½å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                Utils.showMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ ç®¡ç†å‘˜';
            document.getElementById('editForm').reset();
            document.getElementById('adminId').value = '';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('password').required = true;
            document.getElementById('editModal').classList.add('show');
        }
        
        async function editAdmin(id) {
            try {
                const result = await API.get(`/admin/admins/${id}`);
                
                if (result.code === 200) {
                    const admin = result.data;
                    document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç®¡ç†å‘˜';
                    document.getElementById('adminId').value = admin.admin_id;
                    document.getElementById('username').value = admin.username;
                    document.getElementById('nickname').value = admin.nickname || '';
                    document.getElementById('email').value = admin.email || '';
                    document.getElementById('mobile').value = admin.mobile || '';
                    document.getElementById('status').value = admin.status;
                    document.getElementById('passwordGroup').style.display = 'none';
                    document.getElementById('password').required = false;
                    document.getElementById('editModal').classList.add('show');
                } else {
                    Utils.showMessage('è·å–ä¿¡æ¯å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                Utils.showMessage('è·å–ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function saveAdmin() {
            const id = document.getElementById('adminId').value;
            const data = {
                username: document.getElementById('username').value,
                nickname: document.getElementById('nickname').value,
                email: document.getElementById('email').value,
                mobile: document.getElementById('mobile').value,
                status: parseInt(document.getElementById('status').value)
            };
            
            if (!data.username) {
                Utils.showMessage('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            if (id) {
                data.admin_id = parseInt(id);
            } else {
                data.password = document.getElementById('password').value;
                if (!data.password) {
                    Utils.showMessage('è¯·è¾“å…¥å¯†ç ', 'error');
                    return;
                }
            }
            
            try {
                const url = id ? '/admin/admins/update' : '/admin/admins/create';
                const result = await API.post(url, data);
                
                if (result.code === 200) {
                    Utils.showMessage(id ? 'ä¿®æ”¹æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
                    closeModal();
                    loadData();
                } else {
                    Utils.showMessage((id ? 'ä¿®æ”¹' : 'æ·»åŠ ') + 'å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                Utils.showMessage((id ? 'ä¿®æ”¹' : 'æ·»åŠ ') + 'å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function deleteAdmin(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç®¡ç†å‘˜å—ï¼Ÿ')) return;
            
            try {
                const result = await API.post('/admin/admins/delete', { ids: [id] });
                
                if (result.code === 200) {
                    Utils.showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    loadData();
                } else {
                    Utils.showMessage('åˆ é™¤å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                Utils.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login';
            }
        }
        
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        loadData();
    </script>
</body>
</html>
{{end}}