{{define "admin/login.html"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员登录 - 心悦网盘搜索系统</title>
    
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Element Plus 图标 -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            font-size: 14px;
            color: #666;
        }
        
        .login-form {
            margin-top: 30px;
        }
        
        .login-form .el-form-item {
            margin-bottom: 24px;
        }
        
        .login-form .el-input {
            height: 48px;
        }
        
        .login-form .el-input__inner {
            height: 48px;
            line-height: 48px;
        }
        
        .login-button {
            width: 100%;
            height: 48px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }
        
        .login-footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        .login-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="login-container">
            <div class="login-box">
                <div class="login-header">
                    <div class="login-logo">XY</div>
                    <h1 class="login-title">心悦管理后台</h1>
                    <p class="login-subtitle">请登录您的管理员账号</p>
                </div>
                
                <el-form
                    ref="loginForm"
                    :model="form"
                    :rules="rules"
                    class="login-form"
                    @submit.prevent="handleLogin"
                >
                    <el-form-item prop="username">
                        <el-input
                            v-model="form.username"
                            placeholder="请输入用户名"
                            :prefix-icon="User"
                            clearable
                            @keyup.enter="handleLogin"
                        />
                    </el-form-item>
                    
                    <el-form-item prop="password">
                        <el-input
                            v-model="form.password"
                            type="password"
                            placeholder="请输入密码"
                            :prefix-icon="Lock"
                            show-password
                            clearable
                            @keyup.enter="handleLogin"
                        />
                    </el-form-item>
                    
                    <el-form-item>
                        <el-checkbox v-model="form.remember">记住我</el-checkbox>
                    </el-form-item>
                    
                    <el-button
                        type="primary"
                        class="login-button"
                        :loading="loading"
                        @click="handleLogin"
                    >
                        登录
                    </el-button>
                </el-form>
                
                <div class="login-footer">
                    <a href="/" target="_blank">返回首页</a>
                </div>
            </div>
        </div>
    </div>

    <script>
    const { createApp, ref } = Vue;
    const { ElMessage } = ElementPlus;
    const { User, Lock } = ElementPlusIconsVue;
    
    const app = createApp({
        setup() {
            const loginForm = ref(null);
            const loading = ref(false);
            const form = ref({
                username: '',
                password: '',
                remember: false
            });
            
            const rules = {
                username: [
                    { required: true, message: '请输入用户名', trigger: 'blur' },
                    { min: 3, max: 20, message: '用户名长度为3-20个字符', trigger: 'blur' }
                ],
                password: [
                    { required: true, message: '请输入密码', trigger: 'blur' },
                    { min: 6, max: 20, message: '密码长度为6-20个字符', trigger: 'blur' }
                ]
            };
            
            const handleLogin = async () => {
                if (!loginForm.value) return;
                
                try {
                    await loginForm.value.validate();
                } catch (e) {
                    return;
                }
                
                loading.value = true;
                
                try {
                    const response = await axios.post('/api/admin/login', {
                        username: form.value.username,
                        password: form.value.password
                    });
                    
                    if (response.data.code === 200) {
                        // 保存token
                        const token = response.data.data.token;
                        localStorage.setItem('admin_token', token);
                        
                        // 如果勾选记住我，保存用户名
                        if (form.value.remember) {
                            localStorage.setItem('admin_username', form.value.username);
                        } else {
                            localStorage.removeItem('admin_username');
                        }
                        
                        ElMessage.success('登录成功');
                        
                        // 跳转到管理后台
                        setTimeout(() => {
                            window.location.href = '/admin';
                        }, 500);
                    } else {
                        ElMessage.error(response.data.message || '登录失败');
                    }
                } catch (error) {
                    console.error('登录错误:', error);
                    ElMessage.error('登录请求失败，请检查网络连接');
                } finally {
                    loading.value = false;
                }
            };
            
            // 检查是否已登录
            const checkLogin = () => {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    // 验证token是否有效
                    axios.get('/api/admin/check', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    }).then(() => {
                        // token有效，跳转到后台
                        window.location.href = '/admin';
                    }).catch(() => {
                        // token无效，清除
                        localStorage.removeItem('admin_token');
                    });
                }
                
                // 读取记住的用户名
                const savedUsername = localStorage.getItem('admin_username');
                if (savedUsername) {
                    form.value.username = savedUsername;
                    form.value.remember = true;
                }
            };
            
            return {
                loginForm,
                loading,
                form,
                rules,
                handleLogin,
                User,
                Lock,
                checkLogin
            };
        },
        mounted() {
            this.checkLogin();
        }
    });
    
    // 注册所有图标
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component);
    }
    
    app.use(ElementPlus).mount('#app');
    </script>
</body>
</html>
{{end}}