{{define "admin/wechat_config.html"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡é…ç½® - Xinyue</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; }
        .admin-layout { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #001529; color: #fff; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-size: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .sidebar-menu { flex: 1; overflow-y: auto; }
        .menu-item { padding: 15px 20px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,0.65); text-decoration: none; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .menu-item.active { background: #1890ff; color: #fff; }
        .menu-group { margin: 10px 0; }
        .menu-group-title { padding: 10px 20px; color: rgba(255,255,255,0.45); font-size: 12px; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 60px; background: #fff; border-bottom: 1px solid #e8e8e8; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .header-title { font-size: 18px; font-weight: bold; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .user-info { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: background 0.3s; }
        .user-info:hover { background: #f0f0f0; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #1890ff; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .btn-primary { background: #1890ff; color: #fff; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-success { background: #52c41a; color: #fff; }
        .btn-success:hover { background: #73d13d; }
        .btn-default { background: #fff; color: #333; border: 1px solid #d9d9d9; }
        .btn-default:hover { color: #1890ff; border-color: #1890ff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .tabs { display: flex; gap: 2px; background: #fff; border-radius: 4px 4px 0 0; overflow: hidden; margin-bottom: -1px; }
        .tab { padding: 12px 24px; background: #fafafa; cursor: pointer; border: 1px solid #e8e8e8; border-bottom: none; transition: all 0.3s; }
        .tab:hover { background: #f0f0f0; }
        .tab.active { background: #fff; border-bottom: 2px solid #1890ff; color: #1890ff; font-weight: 500; }
        .config-container { background: #fff; border-radius: 0 4px 4px 4px; overflow: hidden; border: 1px solid #e8e8e8; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .config-item { padding: 20px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 20px; }
        .config-item:last-child { border-bottom: none; }
        .config-label { width: 200px; flex-shrink: 0; font-weight: 500; color: #333; }
        .config-label .required { color: #ff4d4f; margin-right: 4px; }
        .config-input-wrapper { flex: 1; max-width: 600px; }
        .config-input { width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; outline: none; }
        .config-input:focus { border-color: #1890ff; }
        textarea.config-input { resize: vertical; min-height: 80px; }
        .config-help { margin-top: 4px; font-size: 12px; color: #999; }
        .config-section { background: #fafafa; padding: 12px 20px; font-weight: 600; color: #333; border-bottom: 1px solid #e8e8e8; }
        .footer { height: 50px; background: #fff; border-top: 1px solid #e8e8e8; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: #999; font-size: 14px; }
        .loading { text-align: center; padding: 40px; color: #999; }
        .save-bar { position: sticky; bottom: 0; background: #fff; padding: 15px 20px; border-top: 1px solid #e8e8e8; display: flex; justify-content: space-between; gap: 10px; }
        .alert { padding: 12px 16px; margin-bottom: 20px; border-radius: 4px; display: none; }
        .alert.success { background: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; }
        .alert.error { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; }
        .alert.show { display: block; }
    </style>
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar">
            <div class="sidebar-header">å¿ƒæ‚¦ç®¡ç†åå°</div>
            <div class="sidebar-menu" id="sidebarMenu"></div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <div class="header-title">å¾®ä¿¡é…ç½®</div>
                <div class="header-right">
                    <a href="/" class="btn btn-default" target="_blank">æŸ¥çœ‹ç½‘ç«™</a>
                    <div class="user-info" onclick="logout()">
                        <div class="avatar">A</div>
                        <span>ç®¡ç†å‘˜</span>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div id="alertBox" class="alert"></div>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('official')">ğŸ“± å¾®ä¿¡å…¬ä¼—å·</div>
                    <div class="tab" onclick="switchTab('chatbot')">ğŸ¤– å¯¹è¯å¼€æ”¾å¹³å°</div>
                </div>
                
                <div class="config-container">
                    <div id="official-tab" class="tab-content active">
                        <div class="config-section">å…¬ä¼—å·é…ç½®</div>
                        <div class="config-item">
                            <div class="config-label">AppID</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="config-input" id="wx_official_appid" placeholder="è¯·è¾“å…¥å…¬ä¼—å·AppID">
                                <div class="config-help">å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">AppSecret</div>
                            <div class="config-input-wrapper">
                                <input type="password" class="config-input" id="wx_official_secret" placeholder="è¯·è¾“å…¥å…¬ä¼—å·AppSecret">
                                <div class="config-help">å…¬ä¼—å·çš„åº”ç”¨å¯†é’¥</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">Token</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="config-input" id="wx_official_token" placeholder="è¯·è¾“å…¥æœåŠ¡å™¨éªŒè¯ä»¤ç‰Œ">
                                <div class="config-help">ç”¨äºéªŒè¯æœåŠ¡å™¨çš„ä»¤ç‰Œ</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">EncodingAESKey</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="config-input" id="wx_official_aeskey" placeholder="è¯·è¾“å…¥æ¶ˆæ¯åŠ å¯†å¯†é’¥">
                                <div class="config-help">æ¶ˆæ¯åŠ å¯†/è§£å¯†å¯†é’¥,43ä½å­—ç¬¦</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chatbot-tab" class="tab-content">
                        <div class="config-section">å¯¹è¯å¼€æ”¾å¹³å°é…ç½®</div>
                        <div class="config-item">
                            <div class="config-label">AppID</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="config-input" id="wx_chat_appid" placeholder="è¯·è¾“å…¥å¯¹è¯å¹³å°AppID">
                                <div class="config-help">å¯¹è¯å¼€æ”¾å¹³å°çš„åº”ç”¨ID</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">Token</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="config-input" id="wx_chat_token" placeholder="è¯·è¾“å…¥APIè®¿é—®ä»¤ç‰Œ">
                                <div class="config-help">ç”¨äºè®¿é—®APIçš„ä»¤ç‰Œ</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">EncodingAESKey</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="config-input" id="wx_chat_aes_key" placeholder="è¯·è¾“å…¥æ¶ˆæ¯åŠ å¯†å¯†é’¥">
                                <div class="config-help">æ¶ˆæ¯åŠ å¯†/è§£å¯†å¯†é’¥</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">æœºå™¨äººåç§°</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="config-input" id="wx_chatbot_name" placeholder="è¯·è¾“å…¥æœºå™¨äººåç§°">
                                <div class="config-help">æ˜¾ç¤ºç»™ç”¨æˆ·çš„æœºå™¨äººåç§°</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">æ¬¢è¿æ¶ˆæ¯</div>
                            <div class="config-input-wrapper">
                                <textarea class="config-input" id="wx_chatbot_welcome" placeholder="è¯·è¾“å…¥ç”¨æˆ·é¦–æ¬¡å¯¹è¯çš„æ¬¢è¿æ¶ˆæ¯"></textarea>
                                <div class="config-help">ç”¨æˆ·é¦–æ¬¡å¯¹è¯æ—¶æ˜¾ç¤ºçš„æ¬¢è¿è¯­</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="save-bar">
                    <div>
                        <button class="btn btn-default" onclick="testConfig()">ğŸ” æµ‹è¯•è¿æ¥</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-default" onclick="location.reload()">é‡ç½®</button>
                        <button class="btn btn-success" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <span>Copyright Â© 2025 å¿ƒæ‚¦ç½‘ç›˜æœç´¢ç³»ç»Ÿ. Powered by Go</span>
                <span id="statusText">å°±ç»ª</span>
            </div>
        </div>
    </div>
    
    <script>
        let currentTab = 'official';
        const configKeys = {
            official: ['wx_official_appid', 'wx_official_secret', 'wx_official_token', 'wx_official_aeskey'],
            chatbot: ['wx_chat_appid', 'wx_chat_token', 'wx_chat_aes_key', 'wx_chatbot_name', 'wx_chatbot_welcome']
        };
        
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login';
            }
        }
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }
        
        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = 'alert ' + type + ' show';
            setTimeout(() => alertBox.classList.remove('show'), 3000);
        }
        
        async function loadConfigs() {
            try {
                const token = localStorage.getItem('admin_token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;
                
                const response = await fetch('/api/admin/configs', { headers });
                const result = await response.json();
                
                if (result.code === 200) {
                    const configs = result.data.list || [];
                    configs.forEach(cfg => {
                        const input = document.getElementById(cfg.name);
                        if (input) input.value = cfg.value || '';
                    });
                    document.getElementById('statusText').textContent = 'é…ç½®å·²åŠ è½½';
                } else if (result.code === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('admin_token');
                    window.location.href = '/admin/login';
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                showAlert('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function saveConfig() {
            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•');
                    window.location.href = '/admin/login';
                    return;
                }
                
                const configs = [];
                const keys = currentTab === 'official' ? configKeys.official : configKeys.chatbot;
                
                keys.forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        configs.push({
                            name: key,
                            value: input.value,
                            title: getConfigTitle(key),
                            description: getConfigDescription(key),
                            type: key.includes('welcome') ? 4 : 1,
                            group: 4
                        });
                    }
                });
                
                const response = await fetch('/api/admin/configs/batch-upsert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ configs })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    showAlert('ä¿å­˜æˆåŠŸï¼', 'success');
                    document.getElementById('statusText').textContent = 'å·²ä¿å­˜';
                } else if (result.code === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('admin_token');
                    window.location.href = '/admin/login';
                } else {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testConfig() {
            const type = currentTab;
            const keys = type === 'official' ? configKeys.official : configKeys.chatbot;
            const empty = keys.filter(k => !document.getElementById(k).value);
            
            if (empty.length > 0) {
                showAlert('è¯·å…ˆå¡«å†™æ‰€æœ‰é…ç½®é¡¹', 'error');
                return;
            }
            
            try {
                showAlert('æµ‹è¯•è¿æ¥ä¸­...', 'success');
                document.getElementById('statusText').textContent = 'æµ‹è¯•ä¸­...';
                
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/admin/test/wechat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        type: type // 'official' æˆ– 'chatbot'
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    showAlert(result.message || 'è¿æ¥æµ‹è¯•æˆåŠŸï¼é…ç½®æœ‰æ•ˆ', 'success');
                    document.getElementById('statusText').textContent = 'è¿æ¥æ­£å¸¸';
                } else {
                    showAlert(result.message || 'è¿æ¥æµ‹è¯•å¤±è´¥', 'error');
                    document.getElementById('statusText').textContent = 'æµ‹è¯•å¤±è´¥';
                }
            } catch (error) {
                showAlert('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                document.getElementById('statusText').textContent = 'æµ‹è¯•å¼‚å¸¸';
            }
        }
        
        function getConfigTitle(key) {
            const titles = {
                'wx_official_appid': 'å…¬ä¼—å·AppID',
                'wx_official_secret': 'å…¬ä¼—å·AppSecret',
                'wx_official_token': 'æœåŠ¡å™¨Token',
                'wx_official_aeskey': 'æ¶ˆæ¯åŠ å¯†å¯†é’¥',
                'wx_chat_appid': 'å¯¹è¯å¹³å°AppID',
                'wx_chat_token': 'APIè®¿é—®Token',
                'wx_chat_aes_key': 'æ¶ˆæ¯åŠ å¯†å¯†é’¥',
                'wx_chatbot_name': 'æœºå™¨äººåç§°',
                'wx_chatbot_welcome': 'æ¬¢è¿æ¶ˆæ¯'
            };
            return titles[key] || key;
        }
        
        function getConfigDescription(key) {
            const descriptions = {
                'wx_official_appid': 'å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†',
                'wx_official_secret': 'å…¬ä¼—å·çš„åº”ç”¨å¯†é’¥',
                'wx_official_token': 'ç”¨äºéªŒè¯æœåŠ¡å™¨çš„ä»¤ç‰Œ',
                'wx_official_aeskey': 'æ¶ˆæ¯åŠ å¯†/è§£å¯†å¯†é’¥',
                'wx_chat_appid': 'å¯¹è¯å¼€æ”¾å¹³å°çš„åº”ç”¨ID',
                'wx_chat_token': 'ç”¨äºè®¿é—®APIçš„ä»¤ç‰Œ',
                'wx_chat_aes_key': 'æ¶ˆæ¯åŠ å¯†/è§£å¯†å¯†é’¥',
                'wx_chatbot_name': 'æ˜¾ç¤ºç»™ç”¨æˆ·çš„æœºå™¨äººåç§°',
                'wx_chatbot_welcome': 'ç”¨æˆ·é¦–æ¬¡å¯¹è¯æ—¶çš„æ¬¢è¿è¯­'
            };
            return descriptions[key] || '';
        }
        
        window.onload = function() {
            loadConfigs();
        };
    </script>
    
    <script src="/static/admin-sidebar.js"></script>
</body>
</html>
{{end}}