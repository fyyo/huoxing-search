{{define "admin/wechat_config.html"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡é…ç½® - Huoxingç®¡ç†åå°</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/admin.css">
    <style>
        .tabs {
            display: flex;
            gap: 2px;
            background: #fff;
            border-radius: 4px 4px 0 0;
            overflow: hidden;
            margin-bottom: -1px;
        }
        .tab {
            padding: 12px 24px;
            background: #fafafa;
            cursor: pointer;
            border: 1px solid #e8e8e8;
            border-bottom: none;
            transition: all 0.3s;
        }
        .tab:hover { background: #f0f0f0; }
        .tab.active {
            background: #fff;
            border-bottom: 2px solid #1890ff;
            color: #1890ff;
            font-weight: 500;
        }
        .config-container {
            background: #fff;
            border-radius: 0 4px 4px 4px;
            overflow: hidden;
            border: 1px solid #e8e8e8;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .config-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .config-item:last-child { border-bottom: none; }
        .config-label {
            width: 200px;
            flex-shrink: 0;
            font-weight: 500;
            color: #333;
        }
        .config-input-wrapper {
            flex: 1;
            max-width: 600px;
        }
        .config-section {
            background: #fafafa;
            padding: 12px 20px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #e8e8e8;
        }
        .save-bar {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding: 15px 20px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar">
            <div class="sidebar-header">ç«æ˜Ÿç®¡ç†åå°</div>
            <div class="sidebar-menu" id="sidebarMenu"></div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-title">å¾®ä¿¡é…ç½®</div>
                <div class="header-right">
                    <a href="/" class="btn btn-default" target="_blank">æŸ¥çœ‹ç½‘ç«™</a>
                    <div class="user-info" onclick="logout()">
                        <div class="avatar">A</div>
                        <span>ç®¡ç†å‘˜</span>
                    </div>
                </div>
            </div>

            <div class="content">
                <div id="alertBox" class="alert"></div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('official')">ğŸ“± å¾®ä¿¡å…¬ä¼—å·</div>
                    <div class="tab" onclick="switchTab('chatbot')">ğŸ¤– å¯¹è¯å¼€æ”¾å¹³å°</div>
                </div>

                <div class="config-container">
                    <div id="official-tab" class="tab-content active">
                        <div class="config-section">å…¬ä¼—å·é…ç½®</div>
                        <div class="config-item">
                            <div class="config-label">AppID</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="form-input" id="wx_official_appid" placeholder="è¯·è¾“å…¥å…¬ä¼—å·AppID">
                                <div class="form-help">å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">AppSecret</div>
                            <div class="config-input-wrapper">
                                <input type="password" class="form-input" id="wx_official_secret" placeholder="è¯·è¾“å…¥å…¬ä¼—å·AppSecret">
                                <div class="form-help">å…¬ä¼—å·çš„åº”ç”¨å¯†é’¥</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">Token</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="form-input" id="wx_official_token" placeholder="è¯·è¾“å…¥æœåŠ¡å™¨éªŒè¯ä»¤ç‰Œ">
                                <div class="form-help">ç”¨äºéªŒè¯æœåŠ¡å™¨çš„ä»¤ç‰Œ</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">EncodingAESKey</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="form-input" id="wx_official_aeskey" placeholder="è¯·è¾“å…¥æ¶ˆæ¯åŠ å¯†å¯†é’¥">
                                <div class="form-help">æ¶ˆæ¯åŠ å¯†/è§£å¯†å¯†é’¥,43ä½å­—ç¬¦</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chatbot-tab" class="tab-content">
                        <div class="config-section">å¯¹è¯å¼€æ”¾å¹³å°é…ç½®</div>
                        <div class="config-item">
                            <div class="config-label">AppID</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="form-input" id="wx_chat_appid" placeholder="è¯·è¾“å…¥å¯¹è¯å¹³å°AppID">
                                <div class="form-help">å¯¹è¯å¼€æ”¾å¹³å°çš„åº”ç”¨ID</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">Token</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="form-input" id="wx_chat_token" placeholder="è¯·è¾“å…¥APIè®¿é—®ä»¤ç‰Œ">
                                <div class="form-help">ç”¨äºè®¿é—®APIçš„ä»¤ç‰Œ</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">EncodingAESKey</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="form-input" id="wx_chat_aes_key" placeholder="è¯·è¾“å…¥æ¶ˆæ¯åŠ å¯†å¯†é’¥">
                                <div class="form-help">æ¶ˆæ¯åŠ å¯†/è§£å¯†å¯†é’¥</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">æœºå™¨äººåç§°</div>
                            <div class="config-input-wrapper">
                                <input type="text" class="form-input" id="wx_chatbot_name" placeholder="è¯·è¾“å…¥æœºå™¨äººåç§°">
                                <div class="form-help">æ˜¾ç¤ºç»™ç”¨æˆ·çš„æœºå™¨äººåç§°</div>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">æ¬¢è¿æ¶ˆæ¯</div>
                            <div class="config-input-wrapper">
                                <textarea class="form-textarea" id="wx_chatbot_welcome" placeholder="è¯·è¾“å…¥ç”¨æˆ·é¦–æ¬¡å¯¹è¯çš„æ¬¢è¿æ¶ˆæ¯"></textarea>
                                <div class="form-help">ç”¨æˆ·é¦–æ¬¡å¯¹è¯æ—¶æ˜¾ç¤ºçš„æ¬¢è¿è¯­</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="save-bar">
                    <div>
                        <button class="btn btn-default" onclick="testConfig()">ğŸ” æµ‹è¯•è¿æ¥</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-default" onclick="resetConfig()">ğŸ”„ é‡ç½®é…ç½®</button>
                        <button class="btn btn-success" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script src="/static/js/admin-sidebar.js"></script>
    <script>
        let currentTab = 'official';
        const configKeys = {
            official: ['wx_official_appid', 'wx_official_secret', 'wx_official_token', 'wx_official_aeskey'],
            chatbot: ['wx_chat_appid', 'wx_chat_token', 'wx_chat_aes_key', 'wx_chatbot_name', 'wx_chatbot_welcome']
        };
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }
        
        async function loadConfigs() {
            try {
                const result = await API.get('/admin/configs');
                if (result.code === 200) {
                    const configs = result.data.list || [];
                    configs.forEach(cfg => {
                        const input = document.getElementById(cfg.name);
                        if (input) input.value = cfg.value || '';
                    });
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                Utils.showMessage('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function saveConfig() {
            try {
                const configs = [];
                const keys = currentTab === 'official' ? configKeys.official : configKeys.chatbot;
                
                keys.forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        configs.push({
                            name: key,
                            value: input.value,
                            title: getConfigTitle(key),
                            description: getConfigDescription(key),
                            type: key.includes('welcome') ? 4 : 1,
                            group: 3
                        });
                    }
                });
                
                const result = await API.post('/admin/configs/batch-upsert', { configs });
                
                if (result.code === 200) {
                    Utils.showMessage('ä¿å­˜æˆåŠŸï¼', 'success');
                } else {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                Utils.showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testConfig() {
            const type = currentTab;
            const keys = type === 'official' ? configKeys.official : configKeys.chatbot;
            const empty = keys.filter(k => !document.getElementById(k).value);
            
            if (empty.length > 0) {
                Utils.showMessage('è¯·å…ˆå¡«å†™æ‰€æœ‰é…ç½®é¡¹', 'error');
                return;
            }
            
            try {
                Utils.showMessage('æµ‹è¯•è¿æ¥ä¸­...', 'info');
                
                const result = await API.post('/admin/test/wechat', {
                    type: type
                });
                
                if (result.code === 200) {
                    Utils.showMessage(result.message || 'è¿æ¥æµ‹è¯•æˆåŠŸï¼é…ç½®æœ‰æ•ˆ', 'success');
                } else {
                    Utils.showMessage(result.message || 'è¿æ¥æµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                Utils.showMessage('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function getConfigTitle(key) {
            const titles = {
                'wx_official_appid': 'å…¬ä¼—å·AppID',
                'wx_official_secret': 'å…¬ä¼—å·AppSecret',
                'wx_official_token': 'æœåŠ¡å™¨Token',
                'wx_official_aeskey': 'æ¶ˆæ¯åŠ å¯†å¯†é’¥',
                'wx_chat_appid': 'å¯¹è¯å¹³å°AppID',
                'wx_chat_token': 'APIè®¿é—®Token',
                'wx_chat_aes_key': 'æ¶ˆæ¯åŠ å¯†å¯†é’¥',
                'wx_chatbot_name': 'æœºå™¨äººåç§°',
                'wx_chatbot_welcome': 'æ¬¢è¿æ¶ˆæ¯'
            };
            return titles[key] || key;
        }
        
        function getConfigDescription(key) {
            const descriptions = {
                'wx_official_appid': 'å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†',
                'wx_official_secret': 'å…¬ä¼—å·çš„åº”ç”¨å¯†é’¥',
                'wx_official_token': 'ç”¨äºéªŒè¯æœåŠ¡å™¨çš„ä»¤ç‰Œ',
                'wx_official_aeskey': 'æ¶ˆæ¯åŠ å¯†/è§£å¯†å¯†é’¥',
                'wx_chat_appid': 'å¯¹è¯å¼€æ”¾å¹³å°çš„åº”ç”¨ID',
                'wx_chat_token': 'ç”¨äºè®¿é—®APIçš„ä»¤ç‰Œ',
                'wx_chat_aes_key': 'æ¶ˆæ¯åŠ å¯†/è§£å¯†å¯†é’¥',
                'wx_chatbot_name': 'æ˜¾ç¤ºç»™ç”¨æˆ·çš„æœºå™¨äººåç§°',
                'wx_chatbot_welcome': 'ç”¨æˆ·é¦–æ¬¡å¯¹è¯æ—¶çš„æ¬¢è¿è¯­'
            };
            return descriptions[key] || '';
        }
        
        function resetConfig() {
            if (confirm('ç¡®å®šè¦é‡ç½®å½“å‰æ ‡ç­¾é¡µçš„é…ç½®å—ï¼Ÿè¿™å°†æ¸…ç©ºæ‰€æœ‰è¾“å…¥å†…å®¹ã€‚')) {
                const keys = currentTab === 'official' ? configKeys.official : configKeys.chatbot;
                keys.forEach(key => {
                    const input = document.getElementById(key);
                    if (input) input.value = '';
                });
                Utils.showMessage('é…ç½®å·²é‡ç½®', 'success');
            }
        }

        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login';
            }
        }
        
        window.onload = function() {
            loadConfigs();
        };
    </script>
</body>
</html>
{{end}}