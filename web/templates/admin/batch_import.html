{{define "admin/batch_import.html"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡å¯¼å…¥ - Huoxingç®¡ç†åå°</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/admin.css">
    <style>
        /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ - ç®€æ´æ‰å¹³åŒ–è®¾è®¡ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        .stat-card {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            border-color: #1890ff;
            box-shadow: 0 2px 12px rgba(24,144,255,0.15);
        }
        .stat-number {
            font-size: 40px;
            font-weight: 700;
            margin-bottom: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .stat-label {
            font-size: 14px;
            color: #8c8c8c;
            font-weight: 400;
        }
        .stat-total .stat-number { color: #1890ff; }
        .stat-success .stat-number { color: #52c41a; }
        .stat-failed .stat-number { color: #ff4d4f; }
        
        /* é”™è¯¯åˆ—è¡¨æ ·å¼ */
        .error-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }
        .error-list::-webkit-scrollbar {
            width: 6px;
        }
        .error-list::-webkit-scrollbar-thumb {
            background: #d9d9d9;
            border-radius: 3px;
        }
        .error-item {
            padding: 10px 14px;
            background: #fff2f0;
            border-left: 3px solid #ff4d4f;
            margin-bottom: 8px;
            font-size: 13px;
            color: #595959;
            border-radius: 2px;
        }
        
        /* è¡¨å•ä¼˜åŒ– */
        .form-textarea {
            border: 1px solid #d9d9d9;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }
        .form-textarea:focus {
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24,144,255,0.2);
        }
        
        /* æŒ‰é’®ç»„ä¼˜åŒ– */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .btn-group .btn {
            flex: 1;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 6px;
        }
        
        /* å¯¼å…¥è¯´æ˜å¡ç‰‡ */
        .alert-info {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 4px;
            padding: 16px 20px;
            line-height: 1.8;
        }
        .alert-info strong {
            color: #389e0d;
            font-weight: 600;
        }
        
        /* è¡¨å•ç»Ÿè®¡ */
        .form-help {
            margin-top: 8px;
            padding: 8px 12px;
            background: #fafafa;
            border-radius: 4px;
            font-size: 13px;
            color: #595959;
            display: flex;
            justify-content: space-between;
        }
        .form-help span {
            font-weight: 600;
            color: #1890ff;
        }
        
        /* è®¾ç½®è¡¨å•ä¼˜åŒ– */
        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        .form-select {
            height: 40px;
            padding: 0 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .form-select:focus {
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24,144,255,0.2);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar">
            <div class="sidebar-header">ç«æ˜Ÿç®¡ç†åå°</div>
            <div class="sidebar-menu" id="sidebarMenu"></div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-title">æ‰¹é‡å¯¼å…¥</div>
                <div class="header-right">
                    <a href="/" class="btn btn-default" target="_blank">æŸ¥çœ‹ç½‘ç«™</a>
                    <div class="user-info" onclick="logout()">
                        <div class="avatar">A</div>
                        <span>ç®¡ç†å‘˜</span>
                    </div>
                </div>
            </div>

            <div class="content">
                <div id="alertBox"></div>

                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="card">
                    <div class="card-title">ğŸ“ å¯¼å…¥è¯´æ˜</div>
                    <div class="alert alert-info">
                        <strong>æ”¯æŒæ ¼å¼:</strong><br>
                        1. çº¯é“¾æ¥: https://pan.quark.cn/s/abc123<br>
                        2. æ ‡é¢˜|é“¾æ¥: é€Ÿåº¦ä¸æ¿€æƒ…|https://pan.quark.cn/s/abc123<br>
                        3. é“¾æ¥|æ ‡é¢˜: https://pan.quark.cn/s/abc123|é€Ÿåº¦ä¸æ¿€æƒ…<br><br>
                        <strong>æ³¨æ„äº‹é¡¹:</strong><br>
                        â€¢ ç©ºè¡Œå’Œä»¥ # å¼€å¤´çš„è¡Œä¼šè¢«å¿½ç•¥<br>
                        â€¢ é‡å¤çš„é“¾æ¥ä¼šè¢«è·³è¿‡<br>
                        â€¢ å»ºè®®æ¯æ¬¡å¯¼å…¥ä¸è¶…è¿‡1000æ¡
                    </div>
                </div>

                <!-- å¯¼å…¥è®¾ç½® -->
                <div class="card">
                    <div class="card-title">âš™ï¸ å¯¼å…¥è®¾ç½®</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">ç½‘ç›˜ç±»å‹</label>
                            <select class="form-select" id="panType">
                                <option value="0">å¤¸å…‹ç½‘ç›˜</option>
                                <option value="2">ç™¾åº¦ç½‘ç›˜</option>
                                <option value="3">é˜¿é‡Œäº‘ç›˜</option>
                                <option value="4">UCç½‘ç›˜</option>
                                <option value="5">è¿…é›·ç½‘ç›˜</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ˜¯å¦ä¸´æ—¶èµ„æº</label>
                            <select class="form-select" id="isTime">
                                <option value="0">æ°¸ä¹…</option>
                                <option value="1">ä¸´æ—¶</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">èµ„æºçŠ¶æ€</label>
                            <select class="form-select" id="status">
                                <option value="1">å¯ç”¨</option>
                                <option value="0">ç¦ç”¨</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- å¯¼å…¥å†…å®¹ -->
                <div class="card">
                    <div class="card-title">ğŸ“‹ å¯¼å…¥å†…å®¹</div>
                    <div class="form-group">
                        <textarea class="form-textarea" id="importContent" placeholder="è¯·åœ¨æ­¤ç²˜è´´è¦å¯¼å…¥çš„èµ„æºé“¾æ¥..." style="min-height: 400px;"></textarea>
                        <div class="form-help">
                            è¡Œæ•°: <span id="lineCount">0</span> | å­—ç¬¦æ•°: <span id="charCount">0</span>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="startImport()">ğŸš€ å¼€å§‹å¯¼å…¥</button>
                        <button class="btn btn-default" onclick="clearContent()">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
                    </div>
                </div>

                <!-- å¯¼å…¥ç»“æœ -->
                <div id="resultSection" class="card" style="display: none;">
                    <div class="card-title">ğŸ“Š å¯¼å…¥ç»“æœ</div>
                    <div class="stats-row">
                        <div class="stat-card stat-total">
                            <div class="stat-number" id="totalCount">0</div>
                            <div class="stat-label">æ€»æ•°</div>
                        </div>
                        <div class="stat-card stat-success">
                            <div class="stat-number" id="successCount">0</div>
                            <div class="stat-label">æˆåŠŸ</div>
                        </div>
                        <div class="stat-card stat-failed">
                            <div class="stat-number" id="failedCount">0</div>
                            <div class="stat-label">å¤±è´¥</div>
                        </div>
                    </div>
                    
                    <div id="errorContainer" style="display: none;">
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e8e8e8;">
                            <strong style="color: #ff4d4f;">âŒ å¤±è´¥è¯¦æƒ…:</strong>
                            <div class="error-list" id="errorList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script src="/static/js/admin-sidebar.js"></script>
    <script>
        function updateStats() {
            const textarea = document.getElementById('importContent');
            const content = textarea.value;
            const lines = content.split('\n').filter(line => {
                const trimmed = line.trim();
                return trimmed !== '' && !trimmed.startsWith('#');
            });
            
            document.getElementById('lineCount').textContent = lines.length;
            document.getElementById('charCount').textContent = content.length;
        }
        
        document.getElementById('importContent').addEventListener('input', updateStats);
        
        function clearContent() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
                document.getElementById('importContent').value = '';
                updateStats();
            }
        }
        
        async function startImport() {
            const content = document.getElementById('importContent').value.trim();
            if (!content) {
                Utils.showMessage('è¯·è¾“å…¥è¦å¯¼å…¥çš„å†…å®¹', 'error');
                return;
            }
            
            const lines = content.split('\n').filter(line => {
                const trimmed = line.trim();
                return trimmed !== '' && !trimmed.startsWith('#');
            });
            
            if (lines.length === 0) {
                Utils.showMessage('æ²¡æœ‰æœ‰æ•ˆçš„å¯¼å…¥å†…å®¹', 'error');
                return;
            }
            
            if (lines.length > 1000) {
                if (!confirm(`å°†å¯¼å…¥ ${lines.length} æ¡è®°å½•ï¼Œå»ºè®®åˆ†æ‰¹å¯¼å…¥ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                    return;
                }
            }
            
            try {
                Utils.showMessage('æ­£åœ¨å¯¼å…¥ä¸­ï¼Œè¯·ç¨å€™...', 'info');
                
                const result = await API.post('/admin/batch-import', {
                    content: content,
                    pan_type: parseInt(document.getElementById('panType').value),
                    is_time: parseInt(document.getElementById('isTime').value),
                    status: parseInt(document.getElementById('status').value)
                });
                
                if (result.code === 200) {
                    const data = result.data;
                    document.getElementById('totalCount').textContent = data.total;
                    document.getElementById('successCount').textContent = data.success;
                    document.getElementById('failedCount').textContent = data.failed;
                    document.getElementById('resultSection').style.display = 'block';
                    
                    if (data.errors && data.errors.length > 0) {
                        const errorList = document.getElementById('errorList');
                        errorList.innerHTML = data.errors.map(error => 
                            `<div class="error-item">${error}</div>`
                        ).join('');
                        document.getElementById('errorContainer').style.display = 'block';
                    } else {
                        document.getElementById('errorContainer').style.display = 'none';
                    }
                    
                    if (data.failed === 0) {
                        Utils.showMessage(`å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${data.success} æ¡è®°å½•`, 'success');
                    } else {
                        Utils.showMessage(`å¯¼å…¥å®Œæˆï¼æˆåŠŸ ${data.success} æ¡ï¼Œå¤±è´¥ ${data.failed} æ¡`, 'info');
                    }
                } else {
                    Utils.showMessage('å¯¼å…¥å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                Utils.showMessage('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login';
            }
        }
        
        updateStats();
    </script>
</body>
</html>
{{end}}