{{define "admin/system_config.html"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿé…ç½® - Huoxing</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
        }
        
        .admin-layout { display: flex; height: 100vh; }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 250px;
            background: #001529;
            color: #fff;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .sidebar-menu { flex: 1; overflow-y: auto; }
        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255,255,255,0.65);
            text-decoration: none;
        }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .menu-item.active { background: #1890ff; color: #fff; }
        .menu-group { margin: 10px 0; }
        .menu-group-title {
            padding: 10px 20px;
            color: rgba(255,255,255,0.45);
            font-size: 12px;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header {
            height: 60px;
            background: #fff;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        .header-title { font-size: 18px; font-weight: bold; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .user-info:hover { background: #f0f0f0; }
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #1890ff;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .config-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: #1890ff; color: #fff; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-success { background: #52c41a; color: #fff; }
        .btn-success:hover { background: #73d13d; }
        .btn-default { background: #fff; color: #333; border: 1px solid #d9d9d9; }
        .btn-default:hover { color: #1890ff; border-color: #1890ff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* é…ç½®å®¹å™¨ */
        .config-container { background: #fff; border-radius: 4px; overflow: hidden; }
        
        /* é…ç½®é¡¹ */
        .config-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .config-item:last-child { border-bottom: none; }
        
        .config-label {
            width: 200px;
            flex-shrink: 0;
            font-weight: 500;
            color: #333;
        }
        .config-label .required {
            color: #ff4d4f;
            margin-right: 4px;
        }
        
        .config-input-wrapper {
            flex: 1;
            max-width: 600px;
        }
        
        .config-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        .config-input:focus { border-color: #1890ff; }
        
        textarea.config-input {
            resize: vertical;
            min-height: 80px;
        }
        
        .config-help {
            margin-top: 4px;
            font-size: 12px;
            color: #999;
        }
        
        .config-section {
            background: #fafafa;
            padding: 12px 20px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #e8e8e8;
        }
        
        /* SEOé¢„è§ˆæ ·å¼ */
        .seo-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .seo-preview-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            font-weight: 500;
        }
        .search-result-preview {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .preview-title {
            color: #1a0dab;
            font-size: 18px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .preview-title:hover { text-decoration: underline; }
        .preview-url {
            color: #006621;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .preview-description {
            color: #545454;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .footer {
            height: 50px;
            background: #fff;
            border-top: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: #999;
            font-size: 14px;
        }
        
        .loading { text-align: center; padding: 40px; color: #999; }
        
        .save-bar {
            background: #fff;
            padding: 15px 20px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">ç«æ˜Ÿç®¡ç†åå°</div>
            <div class="sidebar-menu" id="sidebarMenu">
                <!-- ä¾§è¾¹æ èœå•ç”± admin-sidebar.js åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="header">
                <div class="header-title">ç³»ç»Ÿé…ç½®</div>
                <div class="header-right">
                    <a href="/" class="btn btn-default" target="_blank">æŸ¥çœ‹ç½‘ç«™</a>
                    <div class="user-info" onclick="logout()">
                        <div class="avatar">A</div>
                        <span>ç®¡ç†å‘˜</span>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div class="config-wrapper">
                    <div class="config-container" id="configContainer">
                        <div class="loading">æ­£åœ¨åŠ è½½é…ç½®...</div>
                    </div>
                </div>
            </div>
            
            <div class="save-bar">
                <button class="btn btn-default" onclick="location.reload()">é‡ç½®</button>
                <button class="btn btn-success" onclick="saveConfigs()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
            
            <div class="footer">
                <span>Copyright Â© 2025 ç«æ˜Ÿç½‘ç›˜æœç´¢ç³»ç»Ÿ. Powered by Go</span>
                <span id="configCount">åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>
    
    <script>
        let configs = [];
        
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login';
            }
        }
        
        async function loadConfigs() {
            try {
                const token = localStorage.getItem('admin_token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }
                
                const response = await fetch('/api/admin/configs', { headers: headers });
                const result = await response.json();
                
                if (result.code === 200) {
                    // APIè¿”å›çš„æ•°æ®ç»“æ„æ˜¯ {list: [...], total: ...}
                    configs = result.data.list || [];
                    renderConfigs();
                    document.getElementById('configCount').textContent = `å…± ${configs.length} é¡¹é…ç½®`;
                } else if (result.code === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('admin_token');
                    window.location.href = '/admin/login';
                } else {
                    throw new Error(result.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                document.getElementById('configContainer').innerHTML = 
                    '<div class="loading" style="color:#ff4d4f;">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        function renderConfigs() {
            if (configs.length === 0) {
                document.getElementById('configContainer').innerHTML =
                    '<div class="loading">æš‚æ— é…ç½®é¡¹</div>';
                return;
            }
            
            // è¿‡æ»¤åªæ˜¾ç¤ºåŸºç¡€é…ç½®å’Œæœç´¢é…ç½®(group=0,1)
            // group=2(ç½‘ç›˜)å’Œgroup=3(å¾®ä¿¡)åœ¨ä¸“é—¨çš„é¡µé¢æ˜¾ç¤º
            const filteredConfigs = configs.filter(item => {
                const group = item.group || 0;
                return group === 0 || group === 1;
            });
            
            if (filteredConfigs.length === 0) {
                document.getElementById('configContainer').innerHTML =
                    '<div class="loading">æš‚æ— åŸºç¡€é…ç½®é¡¹</div>';
                return;
            }
            
            // æŒ‰groupåˆ†ç»„
            const grouped = {};
            const groupNames = {
                0: 'åŸºç¡€è®¾ç½®',
                1: 'SEOä¸æœç´¢è®¾ç½®'
            };
            
            filteredConfigs.forEach(item => {
                const group = item.group || 0;
                if (!grouped[group]) {
                    grouped[group] = [];
                }
                grouped[group].push(item);
            });
            
            // æ¸²æŸ“HTML
            let html = '';
            Object.keys(grouped).sort((a, b) => parseInt(a) - parseInt(b)).forEach(group => {
                html += `<div class="config-section">${groupNames[group] || 'å…¶ä»–'}</div>`;
                
                grouped[group].forEach(item => {
                    html += renderConfigItem(item);
                });
                
                // ä¸ºSEOè®¾ç½®åˆ†ç»„æ·»åŠ é¢„è§ˆ
                if (group == '1') {
                    html += renderSEOPreview();
                }
            });
            
            document.getElementById('configContainer').innerHTML = html;
            
            // ä¸ºSEOç›¸å…³è¾“å…¥æ¡†æ·»åŠ å®æ—¶é¢„è§ˆç›‘å¬
            attachSEOListeners();
        }
        
        function renderSEOPreview() {
            return `
                <div class="config-item">
                    <div class="config-label">æœç´¢é¢„è§ˆ</div>
                    <div class="config-input-wrapper">
                        <div class="seo-preview">
                            <div class="seo-preview-title">æ‚¨çš„ç½‘ç«™åœ¨æœç´¢å¼•æ“ä¸­çš„å±•ç¤ºæ•ˆæœï¼š</div>
                            <div class="search-result-preview">
                                <div class="preview-title" id="previewTitle">ç«æ˜Ÿç½‘ç›˜æœç´¢</div>
                                <div class="preview-url">https://your-domain.com</div>
                                <div class="preview-description" id="previewDescription">å¤šç½‘ç›˜èµ„æºæœç´¢ä¸ç®¡ç†å¹³å°</div>
                            </div>
                            <div class="config-help">å…³é”®è¯ä¸ä¼šåœ¨æœç´¢ç»“æœä¸­æ˜¾ç¤ºï¼Œä½†ä¼šå½±å“SEOæ’å</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function attachSEOListeners() {
            // ç›‘å¬ç½‘ç«™åç§°å˜åŒ–
            const nameInputs = document.querySelectorAll('[data-id]');
            nameInputs.forEach(input => {
                const config = configs.find(c => c.conf_id === parseInt(input.dataset.id));
                if (!config) return;
                
                if (config.name === 'site_name') {
                    input.addEventListener('input', function() {
                        const title = this.value || 'ç«æ˜Ÿç½‘ç›˜æœç´¢';
                        document.getElementById('previewTitle').textContent = title;
                    });
                    // åˆå§‹åŒ–
                    if (input.value) {
                        document.getElementById('previewTitle').textContent = input.value;
                    }
                } else if (config.name === 'site_description') {
                    input.addEventListener('input', function() {
                        const desc = this.value || 'å¤šç½‘ç›˜èµ„æºæœç´¢ä¸ç®¡ç†å¹³å°';
                        document.getElementById('previewDescription').textContent = desc;
                    });
                    // åˆå§‹åŒ–
                    if (input.value) {
                        document.getElementById('previewDescription').textContent = input.value;
                    }
                }
            });
        }
        
        function renderConfigItem(item) {
            const required = item.name.includes('*') ? '<span class="required">*</span>' : '';
            const title = item.title || item.name;
            const description = item.description ? `<div class="config-help">${item.description}</div>` : '';
            
            let inputHtml = '';
            
            // æ ¹æ®typeæ¸²æŸ“ä¸åŒçš„è¾“å…¥æ¡†
            switch (item.type) {
                case 2: // æ•°å­—
                    inputHtml = `<input type="number" class="config-input" data-id="${item.conf_id}" value="${item.value || ''}" placeholder="è¯·è¾“å…¥æ•°å­—">`;
                    break;
                case 3: // å¸ƒå°”
                    const checked1 = (item.value == '1' || item.value == 'true') ? 'checked' : '';
                    const checked0 = (!item.value || item.value == '0' || item.value == 'false') ? 'checked' : '';
                    inputHtml = `
                        <div>
                            <label style="margin-right: 20px;">
                                <input type="radio" name="config_${item.conf_id}" value="1" ${checked1} data-id="${item.conf_id}"> å¯ç”¨
                            </label>
                            <label>
                                <input type="radio" name="config_${item.conf_id}" value="0" ${checked0} data-id="${item.conf_id}"> ç¦ç”¨
                            </label>
                        </div>
                    `;
                    break;
                case 4: // JSON/æ–‡æœ¬åŸŸ
                    inputHtml = `<textarea class="config-input" data-id="${item.conf_id}" placeholder="è¯·è¾“å…¥å†…å®¹">${item.value || ''}</textarea>`;
                    break;
                default: // æ–‡æœ¬
                    inputHtml = `<input type="text" class="config-input" data-id="${item.conf_id}" value="${item.value || ''}" placeholder="è¯·è¾“å…¥${title}">`;
            }
            
            return `
                <div class="config-item">
                    <div class="config-label">${required}${title}</div>
                    <div class="config-input-wrapper">
                        ${inputHtml}
                        ${description}
                    </div>
                </div>
            `;
        }
        
        async function saveConfigs() {
            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•');
                    window.location.href = '/admin/login';
                    return;
                }
                
                // æ”¶é›†æ‰€æœ‰é…ç½®é¡¹çš„å€¼
                const updates = [];
                const inputs = document.querySelectorAll('[data-id]');
                
                inputs.forEach(input => {
                    const confId = parseInt(input.dataset.id);
                    let value = '';
                    
                    if (input.type === 'radio' && input.checked) {
                        value = input.value;
                    } else if (input.type !== 'radio') {
                        value = input.value;
                    } else {
                        return; // è·³è¿‡æœªé€‰ä¸­çš„radio
                    }
                    
                    // æŸ¥æ‰¾å¯¹åº”çš„é…ç½®é¡¹
                    const config = configs.find(c => c.conf_id === confId);
                    if (config && !updates.find(u => u.conf_id === confId)) {
                        updates.push({
                            conf_id: confId,
                            name: config.name,
                            value: value
                        });
                    }
                });
                
                if (updates.length === 0) {
                    alert('æ²¡æœ‰éœ€è¦ä¿å­˜çš„é…ç½®');
                    return;
                }
                
                // æ‰¹é‡æ›´æ–°
                const response = await fetch('/api/admin/configs/batch', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ configs: updates })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    alert('ä¿å­˜æˆåŠŸï¼');
                    loadConfigs(); // é‡æ–°åŠ è½½
                } else if (result.code === 401) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('admin_token');
                    window.location.href = '/admin/login';
                } else {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½é…ç½®
        loadConfigs();
    </script>
    
    <!-- å¼•å…¥ä¾§è¾¹æ JS -->
    <script src="/static/admin-sidebar.js"></script>
</body>
</html>
{{end}}